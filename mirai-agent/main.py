#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    MIRAI AUTONOMOUS AGENT                    â•‘
â•‘                    Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞĞ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ AI Ğ°Ğ³ĞµĞ½Ñ‚ Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑĞ¼Ğ¸:
- ğŸ¤– Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ 24/7 Ğ±ĞµĞ· ÑƒÑ‡Ğ°ÑÑ‚Ğ¸Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°
- ğŸ§  ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· GPT-4 Ğ¸ Grok
- ğŸŒ API ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
- ğŸ“± Telegram Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
- ğŸ“Š Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
- ğŸ’¾ ĞŸĞ°Ğ¼ÑÑ‚ÑŒ Ğ² SQLite
"""

import asyncio
import os
import signal
import sys
from pathlib import Path

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² PYTHONPATH
sys.path.insert(0, str(Path(__file__).parent))

from core.master_agent import MasterAgent
from modules.utils.logger import Logger

logger = Logger("MiraiMain").logger


def signal_handler(sig, frame):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ graceful shutdown"""
    logger.info("ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ (%s). Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹...", sig)
    sys.exit(0)


async def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Mirai Agent"""
    
    logger.info("â•" * 70)
    logger.info("ğŸš€ MIRAI AUTONOMOUS AGENT STARTING...")
    logger.info("â•" * 70)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    required_env = [
        "OPENAI_API_KEY",
        "GROK_API_KEY",
        "TELEGRAM_BOT_TOKEN",
        "TELEGRAM_CHAT_ID_ADMIN",
    ]
    
    missing = [var for var in required_env if not os.getenv(var)]
    if missing:
        logger.error("âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ:")
        for var in missing:
            logger.error("   - %s", var)
        logger.info("ğŸ’¡ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ„Ğ°Ğ¹Ğ» .env")
        sys.exit(1)
    
    # Ğ’Ñ‹Ğ²Ğ¾Ğ´ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
    logger.info("ğŸ“‹ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:")
    logger.info("   â€¢ OpenAI API: %s", "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½" if os.getenv("OPENAI_API_KEY") else "âŒ ĞĞµÑ‚")
    logger.info("   â€¢ Grok API: %s", "âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½" if os.getenv("GROK_API_KEY") else "âŒ ĞĞµÑ‚")
    logger.info("   â€¢ Telegram: %s", "âœ… ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" if os.getenv("ENABLE_TELEGRAM") == "true" else "âš ï¸ Ğ’Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½")
    logger.info("   â€¢ DRY RUN: %s", os.getenv("DRY_RUN", "true"))
    logger.info("   â€¢ Autonomous Mode: %s", os.getenv("AUTONOMOUS_MODE", "true"))
    logger.info("â”€" * 70)
    
    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Master Agent
        logger.info("ğŸ¤– Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ MasterAgent...")
        agent = MasterAgent()
        
        logger.info("âœ… MasterAgent ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")
        logger.info("â•" * 70)
        logger.info("ğŸ¯ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°...")
        logger.info("â•" * 70)
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
        await agent.start()
        
    except KeyboardInterrupt:
        logger.info("ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")
    except Exception as e:
        logger.error("ğŸ’¥ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: %s", e, exc_info=True)
        sys.exit(1)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("ğŸ‘‹ Mirai Agent Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
